name: Run Claude Code Command

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Message to send to claude-code'
        required: true
        default: 'hai apa kabar'
        type: string

jobs:
  run-claude-code:
    runs-on: macos-latest  # Changed to macOS since we need Homebrew

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Homebrew
      run: |
        # Homebrew is pre-installed on macOS runners
        brew --version

    - name: Check and Install Claude Code
      run: |
        # Check if Claude Code is already installed using which
        if which claude &> /dev/null; then
          echo "Claude Code is already installed at: $(which claude)"
          echo "Version: $(claude -version 2>/dev/null || echo 'Unable to get version')"
        elif which claude-code &> /dev/null; then
          echo "Claude Code is already installed at: $(which claude-code)"
          echo "Version: $(claude-code --version 2>/dev/null || echo 'Unable to get version')"
        else
          echo "Claude Code not found. Installing via Homebrew..."
          # Install Claude Code
          brew install --cask claude-code

          # Verify installation
          echo "Checking installation..."
          which claude-code && echo "Claude Code successfully installed at: $(which claude-code)" || echo "Installation may have completed but binary not found in PATH"
        fi

    - name: Setup Clauders Function
      run: |
        # Create clauders function with all environment variables
        cat << 'EOF' >> ~/.bashrc

        # Clauders function with pre-configured environment variables
        clauders() {
            # Set environment variables
            export ANTHROPIC_BASE_URL="${ANTHROPIC_BASE_URL:-${{ secrets.ANTHROPIC_BASE_URL }}}"
            export ANTHROPIC_AUTH_TOKEN="${ANTHROPIC_AUTH_TOKEN:-dummyhai}"
            export ANTHROPIC_MODEL="${ANTHROPIC_MODEL:-claude-opus-4.5}"
            export ANTHROPIC_DEFAULT_SONNET_MODEL="${ANTHROPIC_DEFAULT_SONNET_MODEL:-claude-sonnet-4.5}"
            export ANTHROPIC_SMALL_FAST_MODEL="${ANTHROPIC_SMALL_FAST_MODEL:-gemini-2.5-pro}"
            export ANTHROPIC_DEFAULT_HAIKU_MODEL="${ANTHROPIC_DEFAULT_HAIKU_MODEL:-claude-haiku-4.5}"
            export DISABLE_NON_ESSENTIAL_MODEL_CALLS="${DISABLE_NON_ESSENTIAL_MODEL_CALLS:-1}"
            export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC="${CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC:-1}"

            # Run claude with all arguments passed to the function
            claude "$@"
        }
        EOF

        # Source the bashrc to load the function
        source ~/.bashrc

        # Verify function is loaded
        type clauders

    - name: Run Clauders Function
      env:
        ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
      run: |
        echo "Loading clauders function..."
        source ~/.bashrc

        echo "Running: clauders -p \"${{ github.event.inputs.message }}\""
        echo "Base URL: ${ANTHROPIC_BASE_URL:-Not set (using default in function)}"

        # Store clauders output in variable
        VARIABLE_COMMAND=$(clauders -p "${{ github.event.inputs.message }}" 2>&1)

        # Check if command succeeded
        if [ $? -eq 0 ]; then
          echo "Command executed successfully"
          # Uncomment the line below to see the output
          # echo "Output: $VARIABLE_COMMAND"
        else
          echo "Command failed with output:"
          echo "$VARIABLE_COMMAND"
          exit 1
        fi