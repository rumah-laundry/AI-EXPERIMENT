name: Run Claude Code Command

on:
  workflow_dispatch:
    inputs:
      message:
        description: 'Message to send to claude-code'
        required: true
        default: 'hai apa kabar'
        type: string

jobs:
  run-claude-code:
    runs-on: macos-latest  # Changed to macOS since we need Homebrew

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Homebrew
      run: |
        # Homebrew is pre-installed on macOS runners
        brew --version

    - name: Check and Install Claude Code
      run: |
        # Check if Claude Code is already installed
        if command -v claude &> /dev/null; then
          echo "Claude Code is already installed!"
          echo "Version: $(claude -version 2>/dev/null || echo 'Unable to get version')"
          echo "Location: $(which claude)"
        elif command -v claude-code &> /dev/null; then
          echo "Claude Code (as claude-code) is already installed!"
          echo "Version: $(claude-code --version 2>/dev/null || echo 'Unable to get version')"
          echo "Location: $(which claude-code)"
        elif [ -d "/Applications/Claude.app" ] || [ -d "/Applications/Claude Code.app" ]; then
          echo "Claude Code app found in /Applications directory"
          echo "Checking for binary in app bundle..."
          find /Applications -name "claude" -type f 2>/dev/null | head -5 || echo "No claude binary found in app bundles"
        else
          echo "Claude Code not found. Installing via Homebrew..."
          # Install Claude Code
          brew install --cask claude-code

          # Verify installation
          echo "Checking if claude-code is available after installation..."
          if command -v claude-code &> /dev/null; then
            echo "Claude Code successfully installed!"
            which claude-code
            claude-code --version || echo "Version check failed, but installation might have succeeded"
          else
            echo "Installation completed, but claude-code command not found in PATH"
            echo "Checking app bundles..."
            find /Applications -name "*Claude*" -type d 2>/dev/null
          fi
        fi

    - name: Run Claude Code command
      env:
        ANTHROPIC_BASE_URL: http://localhost:4141
        ANTHROPIC_AUTH_TOKEN: dummyhai
        ANTHROPIC_MODEL: claude-opus-4.5
        ANTHROPIC_DEFAULT_SONNET_MODEL: claude-sonnet-4.5
        ANTHROPIC_SMALL_FAST_MODEL: gemini-2.5-pro
        ANTHROPIC_DEFAULT_HAIKU_MODEL: claude-haiku-4.5
        DISABLE_NON_ESSENTIAL_MODEL_CALLS: 1
        CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: 1
      run: |
        echo "Running: claude with environment variables"
        echo "Message: ${{ github.event.inputs.message }}"

        # Export environment variables and run claude command
        export ANTHROPIC_BASE_URL=http://localhost:4141
        export ANTHROPIC_AUTH_TOKEN=dummyhai
        export ANTHROPIC_MODEL=claude-opus-4.5
        export ANTHROPIC_DEFAULT_SONNET_MODEL=claude-sonnet-4.5
        export ANTHROPIC_SMALL_FAST_MODEL=gemini-2.5-pro
        export ANTHROPIC_DEFAULT_HAIKU_MODEL=claude-haiku-4.5
        export DISABLE_NON_ESSENTIAL_MODEL_CALLS=1
        export CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC=1

        # Run claude -version
        claude -version